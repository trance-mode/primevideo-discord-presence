name: Auto Version Bump

on:
  push:
    tags:
      - 'v*'  # v1.2.3 みたいなタグ push に反応

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🧮 Extract version from tag
        id: extract_version
        run: |
          echo "NEW_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: 🛠 Update version in manifest.json
        run: |
          sed -i "s/\"version\": \".*\"/\"version\": \"${NEW_VERSION}\"/" native/extension/manifest.json

      - name: 🛠 Update version in Cargo.toml
        run: |
          sed -i "s/^version = \".*\"/version = \"${NEW_VERSION}\"/" native/Cargo.toml

      - name: 🛠 Update version in log.js (if applicable)
        run: |
          if [ -f native/extension/log.js ]; then
            sed -i "s/const VERSION = '.*'/const VERSION = '${NEW_VERSION}'/" native/extension/log.js
          fi

      - name: ✅ Commit version updates
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add native/extension/manifest.json native/Cargo.toml native/extension/log.js || true
          git commit -m "🔖 Bump version to ${NEW_VERSION}" || echo "No changes to commit"

      - name: 🚀 Push changes
        run: |
          git push
