name: Sync version to files

on:
  push:
    tags:
      - "v*"

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Update manifest.json and log.js
        run: |
          VERSION=$VERSION
          jq --arg v "$VERSION" '.version = $v' extension/manifest.json > tmp && mv tmp extension/manifest.json
          sed -i "s/versionElem.textContent = \".*\";/versionElem.textContent = \"v$VERSION\";/" extension/log.js

      - name: Commit updated files
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add extension/manifest.json extension/log.js
          git commit -m "chore: sync version to manifest and log.js"
          git push
