name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Rust
        uses: actions/setup-rust@v1
        with:
          rust-version: stable

      - name: Build Rust binary
        run: |
          cd native
          cargo build --release

      - name: Restore CRX private key
        run: |
          echo "${{ secrets.CRX_PRIVATE_KEY }}" | base64 -d > extension/key.pem

      - name: Install crx pack tool
        run: npm install -g crx3

      - name: Pack Chrome Extension into .crx
        run: |
          cd extension
          crx pack -o pvdp.crx -p key.pem

      - name: Upload Release Artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: |
            native/target/release/pvdp.exe
            extension/pvdp.crx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
