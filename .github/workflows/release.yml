name: Release and Auto Version Bump

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: windows-latest

    env:
      EXT_MANIFEST: native/extension/manifest.json
      EXT_LOG: native/extension/log.js
      CARGO_FILE: native/Cargo.toml

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üßÆ Extract version from tag
        run: echo "NEW_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: üßæ Download Japanese font
        run: |
          mkdir native/fonts
          curl -L -o native/fonts/NotoSansJP-Regular.ttf https://github.com/googlefonts/noto-cjk/raw/main/Sans/OTF/Japanese/NotoSansJP-Regular.otf

      - name: üìù Update version in manifest.json
        run: |
          sed -i "s/\"version\": \".*\"/\"version\": \"${{ env.NEW_VERSION }}\"/" "${{ env.EXT_MANIFEST }}"

      - name: üìù Update version in log.js
        run: |
          if (Test-Path "${{ env.EXT_LOG }}") {
            (Get-Content "${{ env.EXT_LOG }}" -Raw) -replace "const VERSION = '.*'", "const VERSION = '${{ env.NEW_VERSION }}'" | Set-Content "${{ env.EXT_LOG }}"
          }

      - name: üìù Update version in Cargo.toml
        run: |
          sed -i "s/^version = \".*\"/version = \"${{ env.NEW_VERSION }}\"/" "${{ env.CARGO_FILE }}"

      - name: ‚úÖ Commit version bump
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add ${{ env.EXT_MANIFEST }} ${{ env.EXT_LOG }} ${{ env.CARGO_FILE }} || true
          git commit -m "chore: bump version to ${{ env.NEW_VERSION }}" || echo "no changes"
          git push origin HEAD:main

      - name: üõ† Build release
        run: cargo build --release

      - name: üì¶ Zip files
        run: |
          mkdir upload
          copy target/release/pvdp.exe upload/
          copy target/release/pvdp_installer.exe upload/
          copy target/release/pvdp_uninstaller.exe upload/
          Compress-Archive -Path upload/* -DestinationPath pvdp-${{ env.NEW_VERSION }}.zip

      - name: üöÄ Release to GitHub
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/release/pvdp.exe
            target/release/pvdp_installer.exe
            target/release/pvdp_uninstaller.exe
            pvdp-${{ env.NEW_VERSION }}.zip
